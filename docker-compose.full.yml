version: '3.8'

services:
  # Servidor Firebird
  firebird:
    image: jacobalberty/firebird:latest
    container_name: firebird-server
    restart: unless-stopped
    environment:
      - ISC_PASSWORD=${FIREBIRD_PASSWORD:-masterkey}
      - FIREBIRD_DATABASE=${FIREBIRD_DATABASE:-pirajanet.fdb}
      - FIREBIRD_USER=${FIREBIRD_USER:-SYSDBA}
    ports:
      - "3050:3050"
    volumes:
      - firebird-data:/firebird/data
      - firebird-system:/firebird/system
    networks:
      - firebird-network
    healthcheck:
      test: ["CMD-SHELL", "echo 'SELECT 1 FROM RDB$$DATABASE;' | /usr/local/firebird/bin/isql -user sysdba -password $${ISC_PASSWORD} localhost:employee"]
      interval: 30s
      timeout: 10s
      retries: 3

  # API REST
  firebird-api:
    image: node:18-alpine
    container_name: firebird-api
    restart: unless-stopped
    working_dir: /usr/src/app
    depends_on:
      firebird:
        condition: service_healthy
    ports:
      - "3051:3050"
    environment:
      - NODE_ENV=production
      - DB_HOST=firebird
      - DB_PORT=3050
      - DB_PATH=/firebird/data/${FIREBIRD_DATABASE:-nfautopecas.fdb}
      - DB_USER=${API_USER:-VECTA}
      - DB_PASSWORD=${API_PASSWORD:-vecta123}
      - API_PORT=3050
    networks:
      - firebird-network
    volumes:
      - ./logs:/usr/src/app/logs
      - api-node-modules:/usr/src/app/node_modules
    command: >
      sh -c "
      apk add --no-cache wget curl &&
      echo 'ðŸ“¦ Criando package.json...' &&
      cat > package.json << 'EOFPKG'
      {
        \"name\": \"firebird-api-n8n\",
        \"version\": \"1.0.0\",
        \"main\": \"server.js\",
        \"dependencies\": {
          \"express\": \"^4.18.2\",
          \"node-firebird\": \"^1.1.8\",
          \"body-parser\": \"^1.20.2\",
          \"cors\": \"^2.8.5\",
          \"dotenv\": \"^16.3.1\"
        }
      }
      EOFPKG
      echo 'ðŸ“ Criando server.js...' &&
      cat > server.js << 'EOFJS'
      require('dotenv').config();
      const express = require('express');
      const bodyParser = require('body-parser');
      const cors = require('cors');
      const Firebird = require('node-firebird');
      
      const app = express();
      const PORT = process.env.API_PORT || 3050;
      
      app.use(cors());
      app.use(bodyParser.json());
      app.use((req, res, next) => {
        console.log('[' + new Date().toISOString() + '] ' + req.method + ' ' + req.path);
        next();
      });
      
      const dbConfig = {
        host: process.env.DB_HOST,
        port: parseInt(process.env.DB_PORT) || 3050,
        database: process.env.DB_PATH,
        user: process.env.DB_USER,
        password: process.env.DB_PASSWORD,
        lowercase_keys: false,
        role: null,
        pageSize: 4096
      };
      
      if (!dbConfig.host || !dbConfig.database || !dbConfig.user || !dbConfig.password) {
        console.error('ERRO: ConfiguraÃ§Ãµes do banco incompletas!');
        process.exit(1);
      }
      
      app.get('/api/health', (req, res) => {
        res.json({
          status: 'OK',
          message: 'API Firebird funcionando',
          timestamp: new Date().toISOString(),
          version: '1.0.0'
        });
      });
      
      app.get('/api/info', (req, res) => {
        res.json({
          name: 'Firebird API for n8n',
          version: '1.0.0',
          endpoints: {
            health: 'GET /api/health',
            info: 'GET /api/info',
            testConnection: 'GET /api/test-connection',
            query: 'POST /api/query',
            execute: 'POST /api/execute'
          }
        });
      });
      
      app.get('/api/test-connection', (req, res) => {
        console.log('Testando conexÃ£o com Firebird...');
        Firebird.attach(dbConfig, (err, db) => {
          if (err) {
            console.error('Erro ao conectar:', err.message);
            return res.status(500).json({
              status: 'ERROR',
              message: 'Erro ao conectar ao Firebird',
              error: err.message
            });
          }
          db.query('SELECT CURRENT_TIMESTAMP FROM RDB\$\$DATABASE', (err, result) => {
            if (err) {
              db.detach();
              return res.status(500).json({
                status: 'ERROR',
                message: 'Erro ao executar query',
                error: err.message
              });
            }
            db.detach();
            res.json({
              status: 'OK',
              message: 'ConexÃ£o estabelecida com sucesso',
              serverTime: result[0].CURRENT_TIMESTAMP,
              config: {
                host: dbConfig.host,
                port: dbConfig.port,
                database: dbConfig.database,
                user: dbConfig.user
              }
            });
          });
        });
      });
      
      app.post('/api/query', (req, res) => {
        const { sql, params } = req.body;
        if (!sql) {
          return res.status(400).json({
            status: 'ERROR',
            message: 'SQL query Ã© obrigatÃ³ria'
          });
        }
        if (!sql.trim().toUpperCase().startsWith('SELECT')) {
          return res.status(403).json({
            status: 'ERROR',
            message: 'Apenas SELECT permitido. Use /api/execute para outras operaÃ§Ãµes.'
          });
        }
        Firebird.attach(dbConfig, (err, db) => {
          if (err) {
            return res.status(500).json({
              status: 'ERROR',
              message: 'Erro ao conectar',
              error: err.message
            });
          }
          db.query(sql, params || [], (err, result) => {
            db.detach();
            if (err) {
              return res.status(500).json({
                status: 'ERROR',
                message: 'Erro ao executar query',
                error: err.message
              });
            }
            res.json({
              status: 'OK',
              data: result,
              rowCount: result.length,
              executedAt: new Date().toISOString()
            });
          });
        });
      });
      
      app.post('/api/execute', (req, res) => {
        const { sql, params } = req.body;
        if (!sql) {
          return res.status(400).json({
            status: 'ERROR',
            message: 'SQL Ã© obrigatÃ³rio'
          });
        }
        Firebird.attach(dbConfig, (err, db) => {
          if (err) {
            return res.status(500).json({
              status: 'ERROR',
              message: 'Erro ao conectar',
              error: err.message
            });
          }
          db.query(sql, params || [], (err, result) => {
            if (err) {
              db.detach();
              return res.status(500).json({
                status: 'ERROR',
                message: 'Erro ao executar',
                error: err.message
              });
            }
            db.commit((commitErr) => {
              db.detach();
              if (commitErr) {
                return res.status(500).json({
                  status: 'ERROR',
                  message: 'Erro ao fazer commit',
                  error: commitErr.message
                });
              }
              res.json({
                status: 'OK',
                message: 'Executado com sucesso',
                executedAt: new Date().toISOString()
              });
            });
          });
        });
      });
      
      app.use('*', (req, res) => {
        res.status(404).json({
          status: 'ERROR',
          message: 'Endpoint nÃ£o encontrado'
        });
      });
      
      app.listen(PORT, '0.0.0.0', () => {
        console.log('==========================================');
        console.log('API Firebird iniciada com sucesso!');
        console.log('==========================================');
        console.log('Porta: ' + PORT);
        console.log('Banco: ' + dbConfig.host + ':' + dbConfig.port);
        console.log('Health: http://localhost:' + PORT + '/api/health');
        console.log('==========================================');
      });
      EOFJS
      echo 'ðŸ“¦ Instalando dependÃªncias...' &&
      npm install --production &&
      echo 'ðŸš€ Iniciando API...' &&
      node server.js
      "
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3050/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
      
networks:
  firebird-network:
    driver: bridge

volumes:
  firebird-data:
    driver: local
  firebird-system:
    driver: local
  api-node-modules:
    driver: local
